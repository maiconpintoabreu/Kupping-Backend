name: Build and Deploy with Skaffold

on:
  push:
    branches:
    - master

# Environment variables available to all jobs and steps in this workflow
env:
  GKE_KEY: ${{ secrets.GKE_KEY }}
  GKE_EMAIL: ${{ secrets.GKE_EMAIL }}
  $GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  SSL_FULLCHAIN: ${{ secrets.SSL_FULLCHAIN }}
  SSL_PRIVKEY: ${{ secrets.SSL_PRIVKEY }}
  CONFIG_MAP: ${{ secrets.CONFIG_MAP }}
  GCLOUD_AUTH_JSON: ${{ secrets.GCLOUD_AUTH_JSON }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Kubectl
      run: |
        mkdir $HOME/.kube
        export KUBETEST=$KUBETEST:$KUBE_CONF_CERTIFICATE
        echo $GCLOUD_AUTH_JSON > tempKeyFile.json
        cat tempKeyFile.json
        echo $KUBETEST
        envsubst '\$KUBE_CONF_CERTIFICATE \$KUBE_CONF_HOST \$KUBE_CONF_PASSWORD \$KUBE_CONF \$KUBE_CONF_USERNAME' < kubeconfig > $HOME/.kube/config 
        export KUBECONFIG=$KUBECONFIG:$HOME/.kube/config
        kubectl get po --kubeconfig=$HOME/.kube/config
      env:
        KUBE_CONF_CERTIFICATE: ${{ secrets.KUBE_CONF_CERTIFICATE }}
        KUBE_CONF_HOST: ${{ secrets.KUBE_CONF_HOST }}
        KUBE_CONF_PASSWORD: ${{ secrets.KUBE_CONF_PASSWORD }}
        KUBE_CONF: ${{ secrets.KUBE_CONF }}
        KUBE_CONF_USERNAME: ${{ secrets.KUBE_CONF_USERNAME }}
    - name: Dependencies
      run: |
        sudo -E snap install helm --channel=2.16/stable --classic
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
        chmod +x skaffold
        sudo mv skaffold /usr/local/bin
        mkdir certs
        echo $SSL_FULLCHAIN > certs/fullchain.pem && echo $SSL_PRIVKEY > certs/privkey.pem

    # Deploy the Docker image to the GKE cluster
    - name: Deploy
      run: |
        gcloud auth activate-service-account --key-file=tempKeyFile.json
        gcloud auth configure-docker
        skaffold run --kube-context=$HOME/.kube/config
