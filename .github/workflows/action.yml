name: Build and Deploy with Skaffold

on:
  push:
    branches:
    - master

# Environment variables available to all jobs and steps in this workflow
env:
  GKE_KEY: ${{ secrets.GKE_KEY }}
  GKE_EMAIL: ${{ secrets.GKE_EMAIL }}
  GCP_SSL_PUB: ${{ secrets.GCP_SSL_PUB }}
  $GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  SSL_FULLCHAIN: ${{ secrets.SSL_FULLCHAIN }}
  SSL_PRIVKEY: ${{ secrets.SSL_PRIVKEY }}
  CONFIG_MAP: ${{ secrets.CONFIG_MAP }}
  GCLOUD_AUTH_JSON: ${{ secrets.GCLOUD_AUTH_JSON }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Kubectl
      run: |
        mkdir $HOME/.kube && mkdir $HOME/.ssh
        echo $GCP_SSL_PUB > $HOME/.ssh/gcp-3.pub
        scp -i $HOME/.ssh/gcp-3.pub 35.246.1.136/opt/kubeconfig $HOME/.kube/config
        export KUBECONFIG=$KUBECONFIG:$HOME/.kube/config
        kubectl get po --kubeconfig=$HOME/.kube/config
        echo $GCLOUD_AUTH_JSON > tempKeyFile.json
    - name: Dependencies
      run: |
        sudo -E snap install helm --channel=2.16/stable --classic
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
        chmod +x skaffold
        sudo mv skaffold /usr/local/bin
        mkdir certs
        echo $SSL_FULLCHAIN > certs/fullchain.pem && echo $SSL_PRIVKEY > certs/privkey.pem

    # Deploy the Docker image to the GKE cluster
    - name: Deploy
      run: |
        gcloud auth activate-service-account --key-file=tempKeyFile.json
        gcloud auth configure-docker
        skaffold run --kube-context=$HOME/.kube/config